{% extends "new_base.html" %}

{% load staticfiles %}
{% load i18n %}


{% block title %}
  {% if opening %}
    {% trans 'Edit' %} {{ opening.title }}
  {% else %}
    {% trans 'Add an opening' %}
  {% endif %}

{% endblock title %}


{% block content %}

  <section class="wrapper">
    <div class="row">
      <div class="large-12 columns container">

        {% if opening %}
          <h2>{{ opening.title }} <small>{% trans 'edit opening' %}</small></h2>
        {% else %}
          <h2>{% trans 'Add an opening' %}</h2>
        {% endif %}

        <form action="." method="POST">
          {% csrf_token %}

          {% if form.non_field_errors %}
            <small class="error">
              {% for error in form.non_field_errors %}
                {{ error }}
              {% endfor %}
            </small>
          {% endif %}

          {% for field in form.hidden_fields %}
            {{ field }}
          {% endfor %}
          {% include 'openings/_opening_form_field.html' with field=form.title %}
          <br>
          {% include 'openings/_opening_form_field.html' with field=form.description %}

          {% include 'openings/_opening_form_field.html' with field=form.employment_type %}
          <br>
          {% include 'openings/_opening_form_field.html' with field=form.is_private %}
          <br>
          {% include 'openings/_opening_form_field.html' with field=form.department %}
          <br>
          {% include 'openings/_opening_form_field.html' with field=form.country %}
          <br>
          {% include 'openings/_opening_form_field.html' with field=form.city %}
          <br>
          {% include 'openings/_opening_form_field.html' with field=form.loc_postcode %}

          <div>
            <table class="included-questions">
              <thead>
              <tr>
                <th class="select">{% trans 'Select' %}</th>
                <th class="name"></th>
                <th class="required">{% trans 'Required ?' %}</th>
              </tr>
              </thead>
              <tbody>
              {% for question_form in form.opening_questions %}
                <tr>
                  <td>
                    {{ question_form.included }}
                  </td>
                  <td><label for="{{ question_form.included.auto_id }}">{{ question_form.question }}</label></td>
                  <td>
                    {{ question_form.required }}
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="text-right submit-opening">

            {% if opening %}
              <input type="submit" class="button-positive" value="{% trans 'Save changes' %}" />
            {% else %}
              <input type="submit" class="button-positive" value="{% trans 'Create this opening' %}" />
            {% endif %}

          </div>
        </form>


      </div>
    </div>
  </section>

{% endblock content %}

{% block extrahead %}
  <link rel="stylesheet" href="{% static "css/select2.css" %}" />
{% endblock %}                                                                  
                                                                                
{% block extra-js %}
  <script src="{% static "js/select2.js" %}"></script>
  <script src="{% static "js/cleditor.js" %}"></script>
  <script>
    $(document).ready(function() {

      $('#id_description').cleditor({
          width: $('#id_description').width(),
          controls: "bold italic underline | bullets numbering | outdent indent " +
                  "| alignleft center alignright justify | undo redo |  link unlink | source"
      });

      $('input[id$="included"]').click(function() {
          var $required = $(this).parent().siblings().find('input[id$="required"]');

          if ($(this).is(':checked')) {
            $required.removeAttr("disabled");
          } else {
            $required.prop('checked', false);
            $required.attr("disabled", true);
          }
      });

      $("#id_country").select2({width: '50%'})
      var options = $.map($("#id_department option"), function (el) {
        return el.text;
      });

      function formatState (state) {
          if (state.id == "-1" ) {
            return state.text + " {% trans "(will be created upon saving)" %}";
          } else {
            return state.text;
          }
      }

      $("#id_department").select2({
        width: '50%',
        formatResult: formatState,
        formatSelection: formatState,
        createSearchChoice: function (term, data) {
          if ($(options).filter(function () {
            return term.toLowerCase() == this.toLowerCase();
          }).length === 0) {
            return {id: "-1", text: term};
          }
        },
        prepareElementUpdate: function (data) {
          if (data.id == "-1") {
            $("#id_new_department").val(data.text);
          }
        }
      });
    });
  </script>
{% endblock %}
