{% extends "base.html" %}

{% load i18n %}

{% block title %}
  {{ application.applicant.first_name }} {{ application.applicant.last_name }}
{% endblock title %}

{% block content %}

  <h1>
    {{ application.applicant.first_name }} {{ application.applicant.last_name }}
    <small>{% trans 'applying for ' %}<a href="{% url 'openings:detail_opening' application.opening.id %}">{{ application.opening.title }}</a></small>
  </h1>

  <div class="large-12 columns">
    <a href="" class="button-alert">
      {% trans "Reject" %}
    </a>
    <a href="#" data-reveal-id="transition-form-modal" class="button">
      {% trans "Change stage" %}
    </a>

  <span class="application-rating">
    {% if user_rating != -1 %}
      <a href="{% url 'applications:rate' application.id -1 %}"><i class="icon-thumbs-down"></i></a>
    {% else %}
      <a href="{% url 'applications:rate' application.id 0 %}" class="rate-neutral"><i class="icon-thumbs-down"></i></a>
    {% endif %}

    {{ rating }}

    {% if user_rating != 1 %}
      <a href="{% url 'applications:rate' application.id 1 %}"><i class="icon-thumbs-up"></i></a>
    {% else %}
      <a href="{% url 'applications:rate' application.id 0 %}" class="rate-neutral"><i class="icon-thumbs-up"></i></a>
    {% endif %}
  </span>

  </div>

  <div class="large-8 columns">
    <h2>{% trans 'Informations' %}</h2>
    <i class="icon-envelope"></i> {{ application.applicant.email }}
    <br>
    <br>
    <a href="http://docs.google.com/gview?url={{ application.applicant.resume.url }}" target="_blank"class="button">{% trans 'See resume' %}</a>
    <a href="{{ application.applicant.resume.url }}" target="_blank" class="button">{% trans 'Download resume' %}</a>

    {% if answers %}
      <h4>{% trans 'Answers' %}</h4>
      {% for answer in answers %}
        <p>
          <strong>{{ answer.question.title }}</strong><br>
          {{ answer.answer }}
        </p>
      {% endfor %}
    {% endif %}

    <h2>{% trans 'Discussion' %}</h2>
    {% include 'applications/_comments.html' with application=application new_message_form=new_message_form discussion=discussion %}
  </div>

  <div class="large-4 columns">
    <h2>{% trans 'Event feed' %}</h2>

    {% for transition in application.stage_transitions.all %}
      <div>
        <span>{{ transition.created|date:"Y/m/d" }} - {% trans 'Moved to ' %}{{ transition.stage }}</span>
      </div>
    {% endfor %}
  </div>

  <div id="transition-form-modal" class="reveal-modal">
    <h3>{% trans 'Current stage' %} : {{ application.current_stage }}</h3>
    <form action="." method="POST" id="transition-form">
      {% csrf_token %}

      {% if form.errors %}
        <span class="has-errors"></span>
      {% endif %}

      {% for field in form %}
        <div class="row">
          <div class="large-12 columns {% if field.errors %} error {% endif %}">

            {{ field.label_tag }}
            {{ field }}

            {% if field.errors %}
              <small class="rounded-error">
                {% for error in field.errors %}
                  {{ error }}
                {% endfor %}
              </small>
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <div class="row">
        <a href="{% url 'applications:hire' application.id %}" class="button left">{% trans 'Hire' %}</a>
        <input type="submit" value="{% trans 'Change stage' %}" class="button right" />
      </div>

    </form>
    <a class="close-reveal-modal">&#215;</a>
  </div>

{% endblock content %}

{% block extra-js %}
  <script type="text/javascript">
    $("a.reply-link").click(function(event) {
      event.preventDefault();

      var newForm = $("#new-message-form").clone(),
              link = $(this),
              parentMessage = link.data("reply-to");
      link.after(newForm);
      newForm.find("#id_parent").val(parentMessage);
      newForm.find('label').remove();
      newForm.find('.post-message').val('{% trans 'Reply' %}');
      $(this).remove();
    });

    $(function () {
      if ($("#transition-form").find(".has-errors").length > 0) {
        $("a[data-reveal-id=transition-form-modal]").click();
      }
    })
  </script>
{% endblock extra-js %}
