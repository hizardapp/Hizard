{% extends "base_app.html" %}

{% load i18n %}

{% block content %}
  <header class="applicant">
    <h1>{{ application.applicant.first_name }} {{ application.applicant.last_name }}</h1>
  </header>

  <br><br>

  <div class="section-container tabs" data-section="" data-options="deep_linking: true">

    <section class="section">
      <p class="title"><a href="#dashboard">{% trans 'Dashboard' %}</a></p>
      <div class="content" data-slug="dashboard">
        {% include 'applications/_dashboard_tab.html' with form=form application=application %}
      </div>
    </section>

    <section class="section">
      <p class="title"><a href="#profile">{% trans 'Profile' %}</a></p>
      <div class="content" data-slug="profile">
        {% include 'applications/_profile_tab.html' with application=application %}
      </div>
    </section>

    <section class="section">
      <p class="title"><a href="#resume">{% trans 'Resume' %}</a></p>
      <div class="content" data-slug="resume">
        {% include 'applications/_resume_tab.html' with application=application %}
      </div>
    </section>

    <section class="section">
      <p class="title"><a href="#notes">{% trans 'Discussion' %}</a></p>
      <div class="content" data-slug="notes">
        {% include 'applications/_discussion_tab.html' with application=application new_message_form=new_message_form discussion=discussion %}
      </div>
    </section>
  </div>

  <div id="transition-form-modal" class="reveal-modal">
    <h3>{% trans 'Current stage' %} : {{ application.current_stage }}</h3>
    <form action="#transition-form" method="POST" id="transition-form">
      {% csrf_token %}

      {% if form.errors %}
        <span class="has-errors"></span>
      {% endif %}

      {% for field in form %}
        <div class="row">
          <div class="large-12 columns {% if field.errors %} error {% endif %}">

            {{ field.label_tag }}
            {{ field }}

            {% if field.errors %}
              <small class="rounded-error">
                {% for error in field.errors %}
                  {{ error }}
                {% endfor %}
              </small>
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <div class="row">
        <input type="submit" value="{% trans 'Change stage' %}" class="button-positive right" />
      </div>

    </form>
    <a class="close-reveal-modal">&#215;</a>
  </div>
{% endblock %}

{% block extra-js %}
  <script type="text/javascript">
    $("a.reply-link").click(function (event) {
        event.preventDefault();
        var new_form = $("#new-message-form").clone(),
            link = $(this),
            small_parent = $(link.parents("p")[0]),
            parent_message = link.attr("reply-to");
        small_parent.after(new_form);
        new_form.find("#id_parent").val(parent_message);
    });

    $("textarea#id_note").on("keydown", function () {
      var textarea = $(this),
          str = textarea.val(),
          cols = textarea.attr("cols"),
          linecount = 0;

      $.each(str.split("\n"), function (i, line) {
        linecount += (Math.ceil(line.length / cols) || 1);
      })
      textarea.attr("rows", linecount + 1);
    });

    $(function () {
      if ($("#transition-form").find(".has-errors").length > 0) {
        $("a[data-reveal-id=transition-form-modal]").click();
      }
    })
  </script>
{% endblock extra-js %}
